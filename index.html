<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Кликер Кальмара</title>
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>

        .yandex-context-menu {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        :root {
            --red: #FF0000;
            --pink: #FF6B6B;
            --dark: #1A1A2E;
            --light: #16213E;
            --accent: #00B4D8;
            --text: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Bungee';
            background-color: var(--dark);
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: url('images/background1.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: -webkit-fill-available;
            backdrop-filter: blur(2px);
        }

        header {
            background: linear-gradient(to right, var(--red), var(--pink));
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.8rem;
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 1px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .stat {
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .stat i {
            margin-right: 5px;
            color: var(--accent);
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            position: relative;
            overflow-y: auto;
        }

        .click-area {
            position: relative;
            margin: 10px 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #click-target {
            width: 180px;
            height: 180px;
            background-image: url('images/character1.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background: none !important;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            z-index: 5;
            -webkit-tap-highlight-color: transparent; /* Убирает подсветку при клике */
            -webkit-touch-callout: none; /* Отключает контекстное меню на iOS */
            user-select: none; /* Блокирует выделение текста */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -webkit-touch-callout: none;
            user-drag: none;
            pointer-events: auto; /* Важно: разрешаем события указателя */

        }

        #click-target::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none; /* чтобы клики шли на сам target */
        }

        #click-target.char-1::before {
            background-image: url('images/character1.png');
        }

        #click-target.char-2::before {
            background-image: url('images/character2.png');
        }

        #click-target.char-3::before {
            background-image: url('images/character3.png');
        }

         #click-target.char-4::before {
            background-image: url('images/character4.png');
        }

        @media (min-width: 768px) {
            #click-target {
                width: 220px;
                height: 220px;
            }
        }

        #click-target:active {
            transform: scale(0.95);
        }

        .click-effect {
            position: absolute;
            width: 50px;
            height: 50px;
            background-image: url('images/click-effect.png');
            background-size: contain;
            pointer-events: none;
            z-index: 4;
            opacity: 0;
        }

        .progress-container {
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        #progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--red), var(--pink));
            width: 0%;
            transition: width 0.3s;
            position: relative;
            overflow: hidden;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .upgrades {
            width: 100%;
            max-width: 500px;
            background: rgba(26,26,46,0.8);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            max-height: 30vh;
            overflow-y: auto;
        }

        .upgrade {
            background: linear-gradient(to right, var(--light), var(--dark));
            border-left: 4px solid var(--red);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .upgrade:hover {
            transform: translateX(5px);
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--accent);
        }

        .upgrade-desc {
            font-size: 0.8rem;
            opacity: 0.8;
            font-family: 'Press Start 2P';
        }

        .upgrade-price {
            background: var(--red);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            min-width: 70px;
            text-align: center;
        }

        .upgrade-owned {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 3px;
        }

        .menu-button {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: 'Bungee';
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #8B0000;
            flex: 1;
            max-width: 150px;
        }

        .menu-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #8B0000;
        }

        .sound-button {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            font-family: 'Bungee';
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #8B0000;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .sound-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #8B0000;
        }

        .sound-button.muted::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 3px;
            background: white;
            transform: translate(-50%, -50%) rotate(-45deg);
            transform-origin: center;
        }

        .buttons {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            flex-shrink: 0;
            width: 100%;
            padding: 0 10px;
        }

        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            background-image: url('images/confetti.png');
            background-size: contain;
            pointer-events: none;
            z-index: 20;
            opacity: 0;
        }

        #level-up-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid var(--red);
            text-align: center;
            z-index: 100;
            display: none;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px var(--red);
        }

        #level-up-popup h2 {
            color: var(--red);
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #FF0000;
        }

        #level-up-popup p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        #character-select {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 10px;
        }

        .character-option {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .character-option.selected {
            border-color: var(--red);
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--red);
        }

        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid var(--red);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            color: var(--text);
            text-align: center;
        }

        .loading-progress {
            width: 200px;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(to right, var(--red), var(--pink));
            width: 0%;
            transition: width 0.3s;
        }

        /* Анимации */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes clickEffect {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .float {
            animation: float 3s ease-in-out infinite;
            
        }

        #background-select {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 10px;
        }

        .background-option {
            width: 80px;
            height: 50px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
        }

        .background-option.selected {
            border-color: var(--red);
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--red);
        }

        @media (pointer: coarse) {
            #game-container, #game-container * {
                user-select: none !important;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                -webkit-touch-callout: none !important; /* iOS: блок долгого тапа/контекстного меню */
            }
        }


    </style>
</head>
<body>
    <!-- Прелоадер -->
    <div id="preloader">
        <div class="loader"></div>
        <div class="loading-text">Загрузка игры...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
    </div>

    <!-- Основной контейнер игры -->
    <div id="game-container" style="display: none;">
        <!-- Шапка -->
        <header>
            <h1 class="title">КЛИКЕР КАЛЬМАРА</h1>
            <div class="stats">
                <div class="stat">
                    <i>💰</i> <span id="money-counter">0</span>
                </div>
                <div class="stat">
                    <i>🏆</i> <span id="level-counter">1</span>
                </div>
                <div class="stat">
                    <i>⚡</i> <span id="cps-counter">0</span>/сек
                </div>
            </div>
        </header>

        <!-- Основное содержимое -->
        <main>
            <!-- Прогресс уровня -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span>Уровень <span id="current-level">1</span></span>
                    <span><span id="current-progress">0</span>/<span id="required-progress">100</span></span>
                </div>
            </div>

            <!-- Область кликов -->
            <div class="click-area">
                <div id="click-target" class="float char-1" oncontextmenu="return false"></div>
                <div id="click-effect-container"></div>
               
            </div>

            <!-- Улучшения -->
            <div class="upgrades">
                <div class="upgrade" onclick="buyUpgrade(1)">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Розовый Солдат</div>
                        <div class="upgrade-desc">+0.1 клик/сек</div>
                        <div class="upgrade-owned">Куплено: <span id="upgrade-1-count">0</span></div>
                    </div>
                    <div class="upgrade-price" id="upgrade-1-price">100</div>
                </div>
                
                <div class="upgrade" onclick="buyUpgrade(2)">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Отряд Охранников</div>
                        <div class="upgrade-desc">+0.5 клик/сек</div>
                        <div class="upgrade-owned">Куплено: <span id="upgrade-2-count">0</span></div>
                    </div>
                    <div class="upgrade-price" id="upgrade-2-price">500</div>
                </div>
                
                <div class="upgrade" onclick="buyUpgrade(3)">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Элитная Охрана</div>
                        <div class="upgrade-desc">+1 клик/сек</div>
                        <div class="upgrade-owned">Куплено: <span id="upgrade-3-count">0</span></div>
                    </div>
                    <div class="upgrade-price" id="upgrade-3-price">2000</div>
                </div>
                
                <div class="upgrade" onclick="buyUpgrade(4)">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Фронтмен</div>
                        <div class="upgrade-desc">x2 все клики</div>
                        <div class="upgrade-owned">Куплено: <span id="upgrade-4-count">0</span></div>
                    </div>
                    <div class="upgrade-price" id="upgrade-4-price">10000</div>
                </div>
                
                <div class="upgrade" onclick="buyUpgrade(5)">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Организатор</div>
                        <div class="upgrade-desc">x3 все клики</div>
                        <div class="upgrade-owned">Куплено: <span id="upgrade-5-count">0</span></div>
                    </div>
                    <div class="upgrade-price" id="upgrade-5-price">50000</div>
                </div>
            </div>

            <!-- Кнопки меню -->
            <div class="buttons">
                <button class="menu-button" onclick="showCustomization()">Персонаж</button>
                <button class="sound-button" id="sound-toggle" onclick="toggleSound()">🔊</button>
            </div>
        </main>

        <!-- Попап повышения уровня -->
        <div id="level-up-popup">
            <h2>НОВЫЙ УРОВЕНЬ!</h2>
            <p>Вы достигли уровня <span id="new-level">2</span>!</p>
            <div id="unlock-message">Разблокирована новая функция!</div>
            <div id="character-select">
                <div class="character-option selected" style="background-image: url('images/character1.png');" onclick="selectCharacter(1)"></div>
                <div class="character-option" style="background-image: url('images/character2.png');" onclick="selectCharacter(2)"></div>
                <div class="character-option" style="background-image: url('images/character3.png');" onclick="selectCharacter(3)"></div>
                <div class="character-option" style="background-image: url('images/character4.png');" onclick="selectCharacter(4)"></div>
            </div>
            <div id="background-select">
                <div class="background-option selected" style="background-image: url('images/background1.png');" onclick="selectBackground(1)"></div>
                <div class="background-option" style="background-image: url('images/background2.png');" onclick="selectBackground(2)"></div>
                <div class="background-option" style="background-image: url('images/background3.png');" onclick="selectBackground(3)"></div>
                <div class="background-option" style="background-image: url('images/background4.png');" onclick="selectBackground(4)"></div>
            </div>
            <button class="menu-button" onclick="hideLevelUp()">Продолжить</button>
        </div>
    </div>

    <script>
        
        

        // ===== Блокировка контекстного меню и выделения ===== //
        //document.addEventListener('selectstart', e => e.preventDefault());
        //document.addEventListener('contextmenu', e => e.preventDefault());
       

        

        // ==================== Web Audio API Implementation ====================
        let audioContext;
        let audioBuffers = {};
        let backgroundMusicNode = null;
        let isAudioEnabled = true;

        // Инициализация аудио
        async function initAudio() {
            try {
                // Создаем аудиоконтекст только после пользовательского действия
                document.addEventListener('click', function initAudioContext() {
                    try {
                        if (!audioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            console.log('AudioContext created');
                            loadAllAudio(); // Загружаем звуки после создания контекста
                        }
                    } catch (error) {
                        console.error('Error creating AudioContext:', error);
                    }
                    document.removeEventListener('click', initAudioContext);
                }, { once: true });
            } catch (error) {
                console.error('Audio initialization failed:', error);
            }
        }

        // Загрузка всех звуков
        async function loadAllAudio() {
            if (!audioContext) return;

            const audioFiles = {
                click: 'sounds/click.mp3',
                upgrade: 'sounds/upgrade.mp3',
                levelup: 'sounds/levelup.mp3',
                background: 'sounds/background.mp3'
            };

            try {
                for (const [name, url] of Object.entries(audioFiles)) {
                    try {
                        const response = await fetch(url);
                        const arrayBuffer = await response.arrayBuffer();
                        audioBuffers[name] = await audioContext.decodeAudioData(arrayBuffer);
                        console.log(`Loaded audio: ${name}`);
                    } catch (error) {
                        console.error(`Error loading ${name}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error loading audio files:', error);
            }
        }

        // Воспроизведение звука
        function playSound(name, loop = false) {
            if (!isAudioEnabled || !audioContext || !audioBuffers[name]) return null;

            try {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffers[name];
                source.connect(audioContext.destination);
                source.loop = loop;
                source.start(0);

                if (name === 'background') {
                    // Останавливаем предыдущую фоновую музыку
                    if (backgroundMusicNode) {
                        backgroundMusicNode.stop();
                    }
                    backgroundMusicNode = source;
                }

                return source;
            } catch (error) {
                console.error('Error playing sound:', error);
                return null;
            }
        }

        // Переключение звука
        function toggleSound() {
            isAudioEnabled = !isAudioEnabled;
            const soundButton = document.getElementById('sound-toggle');
            
            if (isAudioEnabled) {
                soundButton.classList.remove('muted');
                playSound('background', true);
            } else {
                soundButton.classList.add('muted');
                if (backgroundMusicNode) {
                    backgroundMusicNode.stop();
                    backgroundMusicNode = null;
                }
            }
            
            // Сохраняем настройки звука
            if (gameState) {
                gameState.audioEnabled = isAudioEnabled;
                gameState.musicEnabled = isAudioEnabled;
                saveGame();
            }
        }

        // ==================== Game Initialization ====================
        let ysdk;
        let gameLanguage = 'ru';

        // Игровые переменные
        let gameState = {
            money: 0,
            level: 1,
            levelProgress: 0,
            levelRequirement: 100,
            totalClicks: 0,
            cps: 0,
            playTime: 0,
            upgrades: [
                { id: 1, name: "Розовый Солдат", price: 100, basePrice: 100, count: 0, cps: 0.1 },
                { id: 2, name: "Отряд Охранников", price: 500, basePrice: 500, count: 0, cps: 0.5 },
                { id: 3, name: "Элитная Охрана", price: 2000, basePrice: 2000, count: 0, cps: 1 },
                { id: 4, name: "Фронтмен", price: 10000, basePrice: 10000, count: 0, multiplier: 2 },
                { id: 5, name: "Организатор", price: 50000, basePrice: 50000, count: 0, multiplier: 3 }
            ],
            selectedCharacter: 1,
            selectedBackground: 1,
            unlockedCharacters: [1],
            unlockedBackgrounds: [1],
            audioEnabled: true,
            musicEnabled: true
        };

        // Персонажи и фоны
        const characters = [
            { id: 1, name: "Ведущий", image: "images/character1.png", unlockLevel: 1 },
            { id: 2, name: "Охранник", image: "images/character2.png", unlockLevel: 3 },
            { id: 3, name: "Кукла", image: "images/character3.png", unlockLevel: 5 },
            { id: 4, name: "Участник", image: "images/character4.png", unlockLevel: 7 }
        ];

        const backgrounds = [
            { id: 1, name: "Арена", image: "images/background1.png", unlockLevel: 1 },
            { id: 2, name: "Коридор", image: "images/background2.png", unlockLevel: 2 },
            { id: 3, name: "Комната", image: "images/background3.png", unlockLevel: 4 },
            { id: 4, name: "Лестница", image: "images/background4.png", unlockLevel: 6 }
        ];

        // DOM элементы
        const preloader = document.getElementById('preloader');
        const gameContainer = document.getElementById('game-container');
        const moneyCounter = document.getElementById('money-counter');
        const levelCounter = document.getElementById('level-counter');
        const cpsCounter = document.getElementById('cps-counter');
        const clickTarget = document.getElementById('click-target');
        const clickEffectContainer = document.getElementById('click-effect-container');
        const progressFill = document.getElementById('progress-fill');
        const currentLevel = document.getElementById('current-level');
        const currentProgress = document.getElementById('current-progress');
        const requiredProgress = document.getElementById('required-progress');
        const levelUpPopup = document.getElementById('level-up-popup');
        const newLevelDisplay = document.getElementById('new-level');
        const unlockMessage = document.getElementById('unlock-message');
        const loadingBar = document.getElementById('loading-bar');
        const soundToggle = document.getElementById('sound-toggle');

        // Блокируем контекстное меню только внутри игры
        gameContainer.addEventListener('contextmenu', e => e.preventDefault());

        // Инициализация Яндекс SDK
        async function initYandexSDK() {
            try {
                ysdk = await YaGames.init();
                console.log('Yandex SDK initialized');
                
                // Определяем язык из SDK
                gameLanguage = ysdk.environment.i18n.lang || 'ru';
                
                // Инициализируем аудио
                await initAudio();
                
                // Запускаем игру
                initGame();
            } catch (err) {
                console.error('Failed to initialize Yandex SDK:', err);
                // Запасной вариант инициализации
                await initAudio();
                initGame();
            }
        }

        // Инициализация игры
        function initGame() {
            // Симулируем загрузку
            let progress = 0;
            const loadInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadInterval);
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        gameContainer.style.display = 'flex';
                        
                        // Уведомляем SDK, что игра готова
                        if (ysdk && ysdk.features.LoadingAPI) {
                            ysdk.features.LoadingAPI.ready();
                            console.log('Game ready notification sent to Yandex SDK');
                        }
                        
                        startGame();
                    }, 500);
                }
                loadingBar.style.width = `${progress}%`;
            }, 200);

            // Загрузка сохранений
            loadGame();
            
            // Настройка обработчиков событий
            setupEventListeners();
            
            // Обновление UI
            updateUI();
            
            // Включаем музыку если она разрешена
            if (gameState.musicEnabled) {
                playSound('background', true);
            } else {
                soundToggle.classList.add('muted');
            }
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
    ickTarget.setAttribute('draggable', 'false');
  clickTarget.style.webkitUserDrag = 'none';
  clickTarget.style.userDrag = 'none';
  clickTarget.addEventListener('dragstart', e => e.preventDefault());

  clickTarget.addEventListener('contextmenu', e => {
    e.preventDefault();
    e.stopPropagation();
    return false;
  });

  // Мышь: только ЛКМ
  clickTarget.addEventListener('mousedown', e => {
    if (e.button === 0) {
      handleClick();
    } else {
      e.preventDefault(); // блок ПКМ/средняя
    }
  });

  // Тач: просто кликаем, БЕЗ preventDefault
  // (всё нежелательное уже заблокировано CSS-ом и contextmenu)
  clickTarget.addEventListener('touchstart', () => {
    handleClick();
  }, { passive: true });
}

            

            clickTarget.addEventListener('touchstart', e => {
                e.preventDefault(); // блокировка системного меню
                handleClick();      // твоя функция клика
            }, { passive: false });

            clickTarget.addEventListener('touchend', e => {
                e.preventDefault(); // предотвращаем появление меню после тапа
            }, { passive: false });

            clickTarget.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            // Блокировка масштабирования на мобильных устройствах
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Блокировка двойного тапа для масштабирования
            // let lastTouch = 0;
            // document.addEventListener('touchend', e => {
            //     const now = Date.now();
            //     if (now - lastTouch <= 300) {
            //         e.preventDefault();
            //     }
            //     lastTouch = now;
            // }, { passive: false });
        

        // Обработка клика
        function handleClick() {
            const clickValue = calculateClickValue();
            gameState.money += clickValue;
            gameState.totalClicks++;
            gameState.levelProgress += clickValue;
            
            // Эффект клика
            createClickEffect();
            playSound('click');
            
            // Проверка уровня
            checkLevelUp();
            
            // Обновление UI
            updateUI();
            
            // Сохранение игры
            saveGame();
        }

        // Расчет значения клика
        function calculateClickValue() {
            let value = 1;
            
            // Применяем множители
            gameState.upgrades.forEach(upgrade => {
                if (upgrade.multiplier && upgrade.count > 0) {
                    value *= upgrade.multiplier;
                }
            });
            
            return value;
        }

        // Расчет CPS (кликов в секунду)
        function calculateCPS() {
            let cps = 0;
            
            gameState.upgrades.forEach(upgrade => {
                if (upgrade.cps) {
                    cps += upgrade.cps * upgrade.count;
                }
            });
            
            // Применяем множители к CPS
            gameState.upgrades.forEach(upgrade => {
                if (upgrade.multiplier && upgrade.count > 0) {
                    cps *= upgrade.multiplier;
                }
            });
            
            return cps;
        }

        // Создание эффекта клика
        function createClickEffect() {
            const effect = document.createElement('div');
            effect.className = 'click-effect';
            effect.style.left = `${Math.random() * 100}%`;
            effect.style.top = `${Math.random() * 100}%`;
            effect.style.animation = 'clickEffect 0.5s forwards';
            
            const value = document.createElement('div');
            value.textContent = `+${calculateClickValue()}`;
            value.style.position = 'absolute';
            value.style.color = 'white';
            value.style.fontWeight = 'bold';
            value.style.textShadow = '0 0 5px black';
            value.style.animation = 'fadeOutUp 1s forwards';
            
            effect.appendChild(value);
            clickEffectContainer.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 500);
        }

        // Проверка повышения уровня
        function checkLevelUp() {
            if (gameState.levelProgress >= gameState.levelRequirement) {
                gameState.level++;
                gameState.levelProgress -= gameState.levelRequirement;
                gameState.levelRequirement = Math.floor(gameState.levelRequirement * 1.5);
                
                // Разблокировка нового контента
                let unlockedSomething = false;
                
                characters.forEach(character => {
                    if (gameState.level >= character.unlockLevel && 
                        !gameState.unlockedCharacters.includes(character.id)) {
                        gameState.unlockedCharacters.push(character.id);
                        unlockMessage.textContent = `Разблокирован персонаж: ${character.name}!`;
                        unlockedSomething = true;
                    }
                });
                
                backgrounds.forEach(background => {
                    if (gameState.level >= background.unlockLevel && 
                        !gameState.unlockedBackgrounds.includes(background.id)) {
                        gameState.unlockedBackgrounds.push(background.id);
                        if (unlockMessage.textContent) {
                            unlockMessage.textContent += ` и новый фон: ${background.name}!`;
                        } else {
                            unlockMessage.textContent = `Разблокирован фон: ${background.name}!`;
                        }
                        unlockedSomething = true;
                    }
                });
                
                if (!unlockedSomething) {
                    unlockMessage.textContent = "Получена награда за уровень!";
                }
                
                // Показ попапа
                showLevelUp();
                
                // Сохранение игры
                saveGame();
            }
        }

        // Показать попап повышения уровня
        function showLevelUp() {
            newLevelDisplay.textContent = gameState.level;
            levelUpPopup.style.display = 'block';
            playSound('levelup');
            createConfetti();
            
            // Обновление доступных персонажей и фонов
            updateCharacterSelect();
            updateBackgroundSelect();
        }

        // Обновление выбора персонажей
        function updateCharacterSelect() {
            const container = document.getElementById('character-select');
            container.innerHTML = '';
            
            characters.forEach(character => {
                if (gameState.unlockedCharacters.includes(character.id)) {
                    const option = document.createElement('div');
                    option.className = `character-option ${gameState.selectedCharacter === character.id ? 'selected' : ''}`;
                    option.style.backgroundImage = `url('${character.image}')`;
                    option.onclick = () => selectCharacter(character.id);
                    container.appendChild(option);
                }
            });
        }

        // Обновление выбора фонов
        function updateBackgroundSelect() {
            const container = document.getElementById('background-select');
            container.innerHTML = '';
            
            backgrounds.forEach(background => {
                if (gameState.unlockedBackgrounds.includes(background.id)) {
                    const option = document.createElement('div');
                    option.className = `background-option ${gameState.selectedBackground === background.id ? 'selected' : ''}`;
                    option.style.backgroundImage = `url('${background.image}')`;
                    option.onclick = () => selectBackground(background.id);
                    container.appendChild(option);
                }
            });
        }

        // Скрыть попап повышения уровня
        function hideLevelUp() {
            levelUpPopup.style.display = 'none';
            unlockMessage.textContent = "";
        }

        // Создание конфетти
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.animation = `confettiFall ${Math.random() * 2 + 2}s linear forwards`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                
                // Случайный персонаж для конфетти
                const randomChar = characters[Math.floor(Math.random() * gameState.unlockedCharacters.length)];
                if (randomChar) {
                    confetti.style.backgroundImage = `url('${randomChar.image}')`;
                }
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // Покупка улучшения
        function buyUpgrade(id) {
            const upgrade = gameState.upgrades.find(u => u.id === id);
            
            if (gameState.money >= upgrade.price) {
                gameState.money -= upgrade.price;
                upgrade.count++;
                upgrade.price = Math.floor(upgrade.basePrice * Math.pow(1.15, upgrade.count));
                gameState.cps = calculateCPS();
                
                // Обновление UI
                updateUI();
                playSound('upgrade');
                
                // Сохранение игры
                saveGame();
                
                // Проверка достижений
                checkAchievements();
            } else {
                // Эффект недостатка денег
                clickTarget.classList.add('shake');
                setTimeout(() => {
                    clickTarget.classList.remove('shake');
                }, 500);
            }
        }


        // Проверка достижений
        function checkAchievements() {
            if (ysdk && ysdk.features.Achievements) {
                // Проверяем различные достижения
                if (gameState.money >= 100000) {
                    ysdk.features.Achievements.setAchievementReached('rich');
                }
                
                if (gameState.level >= 10) {
                    ysdk.features.Achievements.setAchievementReached('level10');
                }
            }
        }

        // Показать кастомизацию
        function showCustomization() {
            showLevelUp();
        }

        // Выбор персонажа
        function selectCharacter(id) {
            if (gameState.unlockedCharacters.includes(id)) {
                gameState.selectedCharacter = id;
                clickTarget.className = `float char-${id}`;
                saveGame();
                
                // Обновление выбранного персонажа в UI
                document.querySelectorAll('.character-option').forEach(el => {
                    el.classList.remove('selected');
                });
                event.target.classList.add('selected');
            }
        }

        // Выбор фона
        function selectBackground(id) {
            if (gameState.unlockedBackgrounds.includes(id)) {
                gameState.selectedBackground = id;
                const background = backgrounds.find(b => b.id === id);
                document.body.style.backgroundImage = `url('${background.image}')`;
                saveGame();
                
                // Обновление выбранного фона в UI
                document.querySelectorAll('.background-option').forEach(el => {
                    el.classList.remove('selected');
                });
                event.target.classList.add('selected');
            }
        }

        // Обновление UI
        function updateUI() {
            moneyCounter.textContent = formatNumber(gameState.money);
            levelCounter.textContent = gameState.level;
            cpsCounter.textContent = formatNumber(gameState.cps);
            
            const progressPercent = (gameState.levelProgress / gameState.levelRequirement) * 100;
            progressFill.style.width = `${progressPercent}%`;
            currentLevel.textContent = gameState.level;
            currentProgress.textContent = Math.floor(gameState.levelProgress);
            requiredProgress.textContent = gameState.levelRequirement;
            
            // Обновление цен улучшений
            gameState.upgrades.forEach(upgrade => {
                document.getElementById(`upgrade-${upgrade.id}-price`).textContent = formatNumber(upgrade.price);
                document.getElementById(`upgrade-${upgrade.id}-count`).textContent = upgrade.count;
                
                // Подсветка доступных улучшений
                const element = document.querySelector(`.upgrade:nth-child(${upgrade.id})`);
                if (gameState.money >= upgrade.price) {
                    element.style.borderLeftColor = 'var(--accent)';
                } else {
                    element.style.borderLeftColor = 'var(--red)';
                }
            });
        }

        // Форматирование чисел
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return Math.floor(num);
        }

        // Загрузка игры
        function loadGame() {
            // Сначала пробуем загрузить из облачного хранилища Яндекс
            if (ysdk && ysdk.features.StorageAPI) {
                ysdk.features.StorageAPI.getItem('squidClickerSave').then(savedData => {
                    if (savedData) {
                        applySaveData(JSON.parse(savedData));
                    } else {
                        // Если в облаке нет, пробуем локальное хранилище
                        loadFromLocalStorage();
                    }
                }).catch(err => {
                    console.error('Failed to load from Yandex cloud storage:', err);
                    loadFromLocalStorage();
                });
            } else {
                // Только локальное хранилище
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('squidClickerSave');
            if (savedData) {
                applySaveData(JSON.parse(savedData));
            }
        }

        function applySaveData(data) {
            // Обновляем состояние игры
            gameState.money = data.money || 0;
            gameState.level = data.level || 1;
            gameState.levelProgress = data.levelProgress || 0;
            gameState.levelRequirement = data.levelRequirement || 100;
            gameState.totalClicks = data.totalClicks || 0;
            gameState.cps = data.cps || 0;
            gameState.playTime = data.playTime || 0;
            gameState.audioEnabled = data.audioEnabled !== undefined ? data.audioEnabled : true;
            gameState.musicEnabled = data.musicEnabled !== undefined ? data.musicEnabled : true;
            gameState.selectedCharacter = data.selectedCharacter || 1;
            gameState.selectedBackground = data.selectedBackground || 1;
            gameState.unlockedCharacters = data.unlockedCharacters || [1];
            gameState.unlockedBackgrounds = data.unlockedBackgrounds || [1];
            
            // Обновляем улучшения
            if (data.upgrades) {
                gameState.upgrades.forEach(upgrade => {
                    const savedUpgrade = data.upgrades.find(u => u.id === upgrade.id);
                    if (savedUpgrade) {
                        upgrade.price = savedUpgrade.price;
                        upgrade.count = savedUpgrade.count;
                    }
                });
            }
            
            // Применяем выбранные персонаж и фон
            const character = characters.find(c => c.id === gameState.selectedCharacter);
            if (character) {
                clickTarget.style.backgroundImage = `url('${character.image}')`;
            }

            clickTarget.setAttribute('oncontextmenu', 'return false'); // Блокировка контекстного меню
            clickTarget.style.touchAction = 'manipulation'; // Оптимизация для тач-устройств
            

            
            const background = backgrounds.find(b => b.id === gameState.selectedBackground);
            if (background) {
                document.body.style.backgroundImage = `url('${background.image}')`;
            }
            
            // Пересчет CPS
            gameState.cps = calculateCPS();
            
            // Обновление UI звука
            if (!gameState.musicEnabled) {
                soundToggle.classList.add('muted');
            }
        }

        // Сохранение игры
        function saveGame() {
            localStorage.setItem('squidClickerSave', JSON.stringify(gameState));
            
            // Сохранение в облако Яндекс
            if (ysdk && ysdk.features.StorageAPI) {
                ysdk.features.StorageAPI.setItem('squidClickerSave', JSON.stringify(gameState)).catch(err => {
                    console.error('Failed to save to Yandex cloud storage:', err);
                });
            }
            
            // Обновление таблицы лидеров
            if (ysdk && ysdk.features.Leaderboards) {
                ysdk.features.Leaderboards.setLeaderboardScore('squidClickerLeaderboard', gameState.money);
            }
        }

        // Автокликеры
        function startAutoClickers() {
            setInterval(() => {
                if (gameState.cps > 0) {
                    const clicks = gameState.cps / 10; // 10 раз в секунду для плавности
                    gameState.money += clicks * calculateClickValue();
                    gameState.levelProgress += clicks * calculateClickValue();
                    gameState.totalClicks += clicks;
                    
                    checkLevelUp();
                    updateUI();
                    
                    // Периодическое сохранение
                    if (Math.random() < 0.1) {
                        saveGame();
                    }
                }
            }, 100);
        }

        // Запуск игры
        function startGame() {
            // Уведомляем SDK о начале игрового процесса
            if (ysdk && ysdk.features.GameplayAPI) {
                ysdk.features.GameplayAPI.start();
                console.log('Gameplay started notification sent to Yandex SDK');
            }
            
            // Запускаем автокликеры
            startAutoClickers();
            
            // Запускаем таймер игры
            setInterval(() => {
                gameState.playTime++;
            }, 1000);
        }

        // Остановка игры
        function stopGame() {
            // Уведомляем SDK о паузе/остановке игры
            if (ysdk && ysdk.features.GameplayAPI) {
                ysdk.features.GameplayAPI.stop();
                console.log('Gameplay stopped notification sent to Yandex SDK');
            }
        }

        // Обработчик видимости страницы для GameplayAPI
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
        stopGame();
        if (backgroundMusicNode) {
            backgroundMusicNode.stop();
            backgroundMusicNode = null;
        }
    } else {
        startGame();
        if (gameState.musicEnabled) {
            playSound('background', true);
        }
    }
        });

        // При закрытии страницы
        window.addEventListener('beforeunload', () => {
            stopGame();
    if (backgroundMusicNode) {
        backgroundMusicNode.stop();
        backgroundMusicNode = null;
    }
    saveGame();
        });

        // Инициализация игры через Яндекс SDK
        initYandexSDK();
    </script>
</body>
</html>